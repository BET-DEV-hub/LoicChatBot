<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatbot Loïc avec Gemini</title>
  <style>
    /* Styles similaires à ceux précédemment fournis */
  </style>
</head>
<body>

<div class="chat-container">
  <div class="header">
    <img src="img/profil/profile.png" alt="Profil">
    Chatbot de Loïc
  </div>

  <div class="messages" id="messages"></div>

  <div class="options">
    <button onclick="newChat()">Nouvelle discussion</button>
    <button onclick="viewHistory()">Voir historique</button>
    <button onclick="setMode('apprendre')">Apprendre</button>
    <button onclick="setMode('discuter')">Discuter / Histoires</button>
    <button onclick="setMode('bepc')">Préparer BEPC</button>
  </div>

  <div class="input-area">
    <input type="text" id="userInput" placeholder="Écris ici, maître Loïc..." />
    <button onclick="sendMessage()">Envoyer</button>
  </div>
</div>

<script>
  let messagesContainer = document.getElementById('messages');
  let userInput = document.getElementById('userInput');
  let mode = 'discuter'; // par défaut
  let history = JSON.parse(localStorage.getItem('chatHistory')) || [];
  let apiKey = localStorage.getItem('gemini_api_key') || '';

  if (!apiKey) {
    apiKey = prompt("Bonjour maître Loïc, entre ta clé API Gemini pour le chatbot :");
    if (apiKey) localStorage.setItem('gemini_api_key', apiKey);
    else alert("Le chatbot nécessite une clé API pour fonctionner.");
  }

  function renderMessages() {
    messagesContainer.innerHTML = '';
    history.forEach(item => {
      let div = document.createElement('div');
      div.classList.add('message', item.role === 'user' ? 'user-msg' : 'bot-msg');
      div.textContent = item.text;
      messagesContainer.appendChild(div);
    });
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function saveHistory() {
    localStorage.setItem('chatHistory', JSON.stringify(history));
  }

  async function sendMessage() {
    let text = userInput.value.trim();
    if (!text) return;
    history.push({ role: 'user', text: text });
    userInput.value = '';
    renderMessages();
    await respond(text);
  }

  async function respond(text) {
    if (!apiKey) {
      alert("Pas de clé API, impossible de répondre.");
      return;
    }

    let prompt = Tu es très gentil, respectueux, tu appelles Loïc "maître". Réponds selon le mode ${mode} : "${text}";

    try {
      const response = await fetch('https://generativelanguage.googleapis.com/v1beta2/models/gemini-2.5-flash:generateText', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': Bearer ${apiKey}
        },
        body: JSON.stringify({
          prompt: prompt,
          temperature: 0.7,
          maxOutputTokens: 150
        })
      });

      const data = await response.json();
      const reply = data.candidates[0].output;

      history.push({ role: 'bot', text: reply });
      renderMessages();
      saveHistory();
    } catch (err) {
      console.error(err);
      const fallback = "Désolé maître Loïc, je n'ai pas pu répondre pour le moment.";
      history.push({ role: 'bot', text: fallback });
      renderMessages();
      saveHistory();
    }
  }

  function newChat() {
    if (confirm("Voulez-vous vraiment commencer une nouvelle discussion ?")) {
      history = [];
      saveHistory();
      renderMessages();
    }
  }

  function viewHistory() {
    alert("Historique enregistré dans le navigateur.\nVous pouvez scroller la conversation pour tout voir.");
  }

  function setMode(newMode) {
    mode = newMode;
    let info = '';
    if (mode === 'discuter') info = 'Mode discussion / création d’histoires activé.';
    else if (mode === 'apprendre') info = 'Mode apprentissage activé.';
    else if (mode === 'bepc') info = 'Mode préparation BEPC activé.';
    history.push({ role: 'bot', text: info });
    renderMessages();
    saveHistory();
  }

  renderMessages();

  userInput.addEventListener("keypress", function (e) {
    if (e.key === 'Enter') sendMessage();
  });
</script>

</body>
</html>
